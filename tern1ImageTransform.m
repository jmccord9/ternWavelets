function [X] = tern1ImageTransform(u,data,dir)

N = size(data,2);
boundType = mod(N,3);

%---------------------------------------------
%          Wavelet Transform
%---------------------------------------------

if dir == 1 % forward transform
    
    if boundType == 0

        X    = zeros(size(data));   Xtemp = X;
        a    = 1:3:N-2;             b     = 2:3:N-1;             c = 3:3:N;
        d1   = 3:3:N;               e1    = 4:3:N+1;e1(end)=N;
        d2   = 0:3:N;d2(1)=1;       e2    = 1:3:N+1;e2(end)=N;
        end1 = 0:3:N-3;end1(1)=1;   end2  = 2:3:N-1;             end3  = 4:3:N+1;end3(end)=N;
        
        X(:,end1,:)        = u{6}(1,1)*data(:,a,:)   + u{6}(2,1)*data(:,b,:)   + u{6}(3,1)*data(:,c,:);
        X(:,end2,:)        = u{6}(1,2)*data(:,a,:)   + u{6}(2,2)*data(:,b,:)   + u{6}(3,2)*data(:,c,:);
        X(:,end3,:)        = u{6}(1,3)*data(:,a,:)   + u{6}(2,3)*data(:,b,:)   + u{6}(3,3)*data(:,c,:);
        Xtemp(:,end1,:)    = u{5}(1,1)*X(:,a,:)      + u{5}(2,1)*X(:,b,:)      + u{5}(3,1)*X(:,c,:);
        Xtemp(:,end2,:)    = u{5}(1,2)*X(:,a,:)      + u{5}(2,2)*X(:,b,:)      + u{5}(3,2)*X(:,c,:);
        Xtemp(:,end3,:)    = u{5}(1,3)*X(:,a,:)      + u{5}(2,3)*X(:,b,:)      + u{5}(3,3)*X(:,c,:);       
        X(:,end1,:)        = u{4}(1,1)*Xtemp(:,a,:)  + u{4}(2,1)*Xtemp(:,b,:)  + u{4}(3,1)*Xtemp(:,c,:);
        X(:,end2,:)        = u{4}(1,2)*Xtemp(:,a,:)  + u{4}(2,2)*Xtemp(:,b,:)  + u{4}(3,2)*Xtemp(:,c,:);
        X(:,end3,:)        = u{4}(1,3)*Xtemp(:,a,:)  + u{4}(2,3)*Xtemp(:,b,:)  + u{4}(3,3)*Xtemp(:,c,:);
        Xtemp(:,end1,:)    = u{3}(1,1)*X(:,a,:)      + u{3}(2,1)*X(:,b,:)      + u{3}(3,1)*X(:,c,:);
        Xtemp(:,end2,:)    = u{3}(1,2)*X(:,a,:)      + u{3}(2,2)*X(:,b,:)      + u{3}(3,2)*X(:,c,:);
        Xtemp(:,end3,:)    = u{3}(1,3)*X(:,a,:)      + u{3}(2,3)*X(:,b,:)      + u{3}(3,3)*X(:,c,:);       
        X(:,end1,:)        = u{2}(1,1)*Xtemp(:,a,:)  + u{2}(2,1)*Xtemp(:,b,:)  + u{2}(3,1)*Xtemp(:,c,:);
        X(:,end2,:)        = u{2}(1,2)*Xtemp(:,a,:)  + u{2}(2,2)*Xtemp(:,b,:)  + u{2}(3,2)*Xtemp(:,c,:);
        X(:,end3,:)        = u{2}(1,3)*Xtemp(:,a,:)  + u{2}(2,3)*Xtemp(:,b,:)  + u{2}(3,3)*Xtemp(:,c,:);
        Xtemp(:,1:3:N-2,:) = u{1}(1,1)*X(:,a,:)      + u{1}(2,1)*X(:,b,:)      + u{1}(3,1)*X(:,c,:);
        Xtemp(:,2:3:N-1,:) = u{1}(1,2)*X(:,a,:)      + u{1}(2,2)*X(:,b,:)      + u{1}(3,2)*X(:,c,:);
        Xtemp(:,3:3:N,:)   = u{1}(1,3)*X(:,a,:)      + u{1}(2,3)*X(:,b,:)      + u{1}(3,3)*X(:,c,:);
        Bminus             = u{7}(1,1)*Xtemp(:,d1,:) + u{7}(2,1)*Xtemp(:,e1,:);
        Bplus              = u{7}(1,2)*Xtemp(:,d2,:) + u{7}(2,2)*Xtemp(:,e2,:);
        Bminus(:,end,:)    = Bplus(:,end,:);
        X                  = [Xtemp(:,2:3:N-1,:),Bplus(:,1:1:end-1,:),Bminus];
        
    elseif boundType == 1
        
        X    = zeros(size(data));   Xtemp = X;
        a0 = 3:3:N-1;               b0 = 4:3:N;     c0 = 5:3:N+1;c0(end) = N-1;
        a1 = 0:3:N-1;a1(1) = 2;     b1 = 1:3:N;     c1 = 2:3:N+1;c1(end) = N-1;
        a2 = 0:3:N-4;a2(1) = 2;     b2 = 1:3:N-3;   c2 = 2:3:N-2;
        d  = 2:3:N-2;               e  = 3:3:N-1;
        end1 = 2:3:N-2;             end2 = 1:3:N;   end3 = 3:3:N-1;
        
        X(:,end1,:)        = u{6}(1,1)*data(:,a0,:)  + u{6}(2,1)*data(:,b0,:)  + u{6}(3,1)*data(:,c0,:);
        X(:,end2,:)        = u{6}(1,2)*data(:,a1,:)  + u{6}(2,2)*data(:,b1,:)  + u{6}(3,2)*data(:,c1,:);
        X(:,end3,:)        = u{6}(1,3)*data(:,a2,:)  + u{6}(2,3)*data(:,b2,:)  + u{6}(3,3)*data(:,c2,:);        
        Xtemp(:,end1,:)    = u{5}(1,1)*X(:,a0,:)     + u{5}(2,1)*X(:,b0,:)     + u{5}(3,1)*X(:,c0,:);
        Xtemp(:,end2,:)    = u{5}(1,2)*X(:,a1,:)     + u{5}(2,2)*X(:,b1,:)     + u{5}(3,2)*X(:,c1,:);
        Xtemp(:,end3,:)    = u{5}(1,3)*X(:,a2,:)     + u{5}(2,3)*X(:,b2,:)     + u{5}(3,3)*X(:,c2,:);        
        X(:,end1,:)        = u{4}(1,1)*Xtemp(:,a0,:) + u{4}(2,1)*Xtemp(:,b0,:) + u{4}(3,1)*Xtemp(:,c0,:);
        X(:,end2,:)        = u{4}(1,2)*Xtemp(:,a1,:) + u{4}(2,2)*Xtemp(:,b1,:) + u{4}(3,2)*Xtemp(:,c1,:);
        X(:,end3,:)        = u{4}(1,3)*Xtemp(:,a2,:) + u{4}(2,3)*Xtemp(:,b2,:) + u{4}(3,3)*Xtemp(:,c2,:);        
        Xtemp(:,end1,:)    = u{3}(1,1)*X(:,a0,:)     + u{3}(2,1)*X(:,b0,:)     + u{3}(3,1)*X(:,c0,:);
        Xtemp(:,end2,:)    = u{3}(1,2)*X(:,a1,:)     + u{3}(2,2)*X(:,b1,:)     + u{3}(3,2)*X(:,c1,:);
        Xtemp(:,end3,:)    = u{3}(1,3)*X(:,a2,:)     + u{3}(2,3)*X(:,b2,:)     + u{3}(3,3)*X(:,c2,:);        
        X(:,end1,:)        = u{2}(1,1)*Xtemp(:,a0,:) + u{2}(2,1)*Xtemp(:,b0,:) + u{2}(3,1)*Xtemp(:,c0,:);
        X(:,end2,:)        = u{2}(1,2)*Xtemp(:,a1,:) + u{2}(2,2)*Xtemp(:,b1,:) + u{2}(3,2)*Xtemp(:,c1,:);
        X(:,end3,:)        = u{2}(1,3)*Xtemp(:,a2,:) + u{2}(2,3)*Xtemp(:,b2,:) + u{2}(3,3)*Xtemp(:,c2,:);       
        Xtemp(:,3:3:N-1,:) = u{1}(1,1)*X(:,a0,:)     + u{1}(2,1)*X(:,b0,:)     + u{1}(3,1)*X(:,c0,:);
        Xtemp(:,1:3:N,:)   = u{1}(1,2)*X(:,a1,:)     + u{1}(2,2)*X(:,b1,:)     + u{1}(3,2)*X(:,c1,:);
        Xtemp(:,2:3:N-2,:) = u{1}(1,3)*X(:,a2,:)     + u{1}(2,3)*X(:,b2,:)     + u{1}(3,3)*X(:,c2,:);
        Bminus             = u{7}(1,1)*Xtemp(:,d,:)  + u{7}(2,1)*Xtemp(:,e,:);
        Bplus              = u{7}(1,2)*Xtemp(:,d,:)  + u{7}(2,2)*Xtemp(:,e,:);
        X                  = [Xtemp(:,1:3:N,:),Bplus,Bminus];
        
    elseif boundType == 2
        
        X    = zeros(size(data));   Xtemp = X;
        a0   = 3:3:N-2;             b0    = 4:3:N-1;            c0 = 5:3:N;
        a    = 0:3:N-2;a(1)=2;      b     = 1:3:N-1;            c  = 2:3:N; 
        d    = 2:3:N;               e     = 3:3:N+1;e(end)=N;
        end1 = 2:3:N-3;             end2  = 1:3:N-1;            end3 = 3:3:N+1;end3(end) = N;
        
        X(:,end1,:)        = u{6}(1,1)*data(:,a0,:)  + u{6}(2,1)*data(:,b0,:)  + u{6}(3,1)*data(:,c0,:);
        X(:,end2,:)        = u{6}(1,2)*data(:,a,:)   + u{6}(2,2)*data(:,b,:)   + u{6}(3,2)*data(:,c,:);
        X(:,end3,:)        = u{6}(1,3)*data(:,a,:)   + u{6}(2,3)*data(:,b,:)   + u{6}(3,3)*data(:,c,:);        
        Xtemp(:,end1,:)    = u{5}(1,1)*X(:,a0,:)     + u{5}(2,1)*X(:,b0,:)     + u{5}(3,1)*X(:,c0,:);
        Xtemp(:,end2,:)    = u{5}(1,2)*X(:,a,:)      + u{5}(2,2)*X(:,b,:)      + u{5}(3,2)*X(:,c,:);
        Xtemp(:,end3,:)    = u{5}(1,3)*X(:,a,:)      + u{5}(2,3)*X(:,b,:)      + u{5}(3,3)*X(:,c,:);        
        X(:,end1,:)        = u{4}(1,1)*Xtemp(:,a0,:) + u{4}(2,1)*Xtemp(:,b0,:) + u{4}(3,1)*Xtemp(:,c0,:);
        X(:,end2,:)        = u{4}(1,2)*Xtemp(:,a,:)  + u{4}(2,2)*Xtemp(:,b,:)  + u{4}(3,2)*Xtemp(:,c,:);
        X(:,end3,:)        = u{4}(1,3)*Xtemp(:,a,:)  + u{4}(2,3)*Xtemp(:,b,:)  + u{4}(3,3)*Xtemp(:,c,:);        
        Xtemp(:,end1,:)    = u{3}(1,1)*X(:,a0,:)     + u{3}(2,1)*X(:,b0,:)     + u{3}(3,1)*X(:,c0,:);
        Xtemp(:,end2,:)    = u{3}(1,2)*X(:,a,:)      + u{3}(2,2)*X(:,b,:)      + u{3}(3,2)*X(:,c,:);
        Xtemp(:,end3,:)    = u{3}(1,3)*X(:,a,:)      + u{3}(2,3)*X(:,b,:)      + u{3}(3,3)*X(:,c,:);        
        X(:,end1,:)        = u{2}(1,1)*Xtemp(:,a0,:) + u{2}(2,1)*Xtemp(:,b0,:) + u{2}(3,1)*Xtemp(:,c0,:);
        X(:,end2,:)        = u{2}(1,2)*Xtemp(:,a,:)  + u{2}(2,2)*Xtemp(:,b,:)  + u{2}(3,2)*Xtemp(:,c,:);
        X(:,end3,:)        = u{2}(1,3)*Xtemp(:,a,:)  + u{2}(2,3)*Xtemp(:,b,:)  + u{2}(3,3)*Xtemp(:,c,:);                       
        Xtemp(:,3:3:N-2,:) = u{1}(1,1)*X(:,a0,:)     + u{1}(2,1)*X(:,b0,:)     + u{1}(3,1)*X(:,c0,:);;
        Xtemp(:,1:3:N-1,:) = u{1}(1,2)*X(:,a,:)      + u{1}(2,2)*X(:,b,:)      + u{1}(3,2)*X(:,c,:);;
        Xtemp(:,2:3:N,:)   = u{1}(1,3)*X(:,a,:)      + u{1}(2,3)*X(:,b,:)      + u{1}(3,3)*X(:,c,:);;
        Bminus             = u{7}(1,1)*Xtemp(:,d,:)     + u{7}(2,1)*Xtemp(:,e,:);
        Bplus              = u{7}(1,2)*Xtemp(:,d,:)     + u{7}(2,2)*Xtemp(:,e,:);
        Bminus(:,end,:)    = Bplus(:,end,:);
        X                  = [Xtemp(:,1:3:N-1,:),Bplus(:,1:1:end-1,:),Bminus]; 
        
    end
    
elseif dir == -1 % backward transform
    
    if boundType == 0
        
        n    = N/3;
        X    = zeros(size(data));   Xtemp = X;
        d    = 2*n+1:1:N-1;         e     = n+2:1:2*n;
        a = 1:3:N-2;                b     = 2:3:N-1;      c    = 3:3:N;
        end1 = 0:3:N-3;end1(1)=1;   end2  = 2:3:N-1;      end3 = 4:3:N+1;end3(end)=N;
        
        X(:,2:3:N-1,:)  = data(:,1:1:n,:);
        X(:,3:3:N-3,:)  = u{7}(1,1)*data(:,d,:)  + u{7}(1,2)*data(:,e,:);
        X(:,4:3:N-2,:)  = u{7}(2,1)*data(:,d,:)  + u{7}(2,2)*data(:,e,:);
        X(:,[1 N],:)    = u{7}(2,2)*data(:,[n+1 N],:);        
        Xtemp(:,end1,:) = u{1}(1,1)*X(:,a,:)     + u{1}(1,2)*X(:,b,:)     + u{1}(1,3)*X(:,c,:);
        Xtemp(:,end2,:) = u{1}(2,1)*X(:,a,:)     + u{1}(2,2)*X(:,b,:)     + u{1}(2,3)*X(:,c,:);
        Xtemp(:,end3,:) = u{1}(3,1)*X(:,a,:)     + u{1}(3,2)*X(:,b,:)     + u{1}(3,3)*X(:,c,:);        
        X(:,end1,:)     = u{2}(1,1)*Xtemp(:,a,:) + u{2}(1,2)*Xtemp(:,b,:) + u{2}(1,3)*Xtemp(:,c,:);
        X(:,end2,:)     = u{2}(2,1)*Xtemp(:,a,:) + u{2}(2,2)*Xtemp(:,b,:) + u{2}(2,3)*Xtemp(:,c,:);
        X(:,end3,:)     = u{2}(3,1)*Xtemp(:,a,:) + u{2}(3,2)*Xtemp(:,b,:) + u{2}(3,3)*Xtemp(:,c,:);        
        Xtemp(:,end1,:) = u{3}(1,1)*X(:,a,:)     + u{3}(1,2)*X(:,b,:)     + u{3}(1,3)*X(:,c,:);
        Xtemp(:,end2,:) = u{3}(2,1)*X(:,a,:)     + u{3}(2,2)*X(:,b,:)     + u{3}(2,3)*X(:,c,:);
        Xtemp(:,end3,:) = u{3}(3,1)*X(:,a,:)     + u{3}(3,2)*X(:,b,:)     + u{3}(3,3)*X(:,c,:);        
        X(:,end1,:)     = u{4}(1,1)*Xtemp(:,a,:) + u{4}(1,2)*Xtemp(:,b,:) + u{4}(1,3)*Xtemp(:,c,:);
        X(:,end2,:)     = u{4}(2,1)*Xtemp(:,a,:) + u{4}(2,2)*Xtemp(:,b,:) + u{4}(2,3)*Xtemp(:,c,:);
        X(:,end3,:)     = u{4}(3,1)*Xtemp(:,a,:) + u{4}(3,2)*Xtemp(:,b,:) + u{4}(3,3)*Xtemp(:,c,:);
        Xtemp(:,end1,:) = u{5}(1,1)*X(:,a,:)     + u{5}(1,2)*X(:,b,:)     + u{5}(1,3)*X(:,c,:);
        Xtemp(:,end2,:) = u{5}(2,1)*X(:,a,:)     + u{5}(2,2)*X(:,b,:)     + u{5}(2,3)*X(:,c,:);
        Xtemp(:,end3,:) = u{5}(3,1)*X(:,a,:)     + u{5}(3,2)*X(:,b,:)     + u{5}(3,3)*X(:,c,:);
        X(:,1:3:N-2,:)  = u{6}(1,1)*Xtemp(:,a,:) + u{6}(1,2)*Xtemp(:,b,:) + u{6}(1,3)*Xtemp(:,c,:);
        X(:,2:3:N-1,:)  = u{6}(2,1)*Xtemp(:,a,:) + u{6}(2,2)*Xtemp(:,b,:) + u{6}(2,3)*Xtemp(:,c,:);
        X(:,3:3:N,:)    = u{6}(3,1)*Xtemp(:,a,:) + u{6}(3,2)*Xtemp(:,b,:) + u{6}(3,3)*Xtemp(:,c,:);
        
    elseif boundType == 1
        
        n  = (N+2)/3;
        X  = zeros(size(data));   Xtemp = X;
        a0 = 3:3:N-1;             b0    = 4:3:N;         c0   = 5:3:N+1;c0(end)=N-1;
        a1 = 0:3:N-1;a1(1)=2;     b1    = 1:3:N;         c1   = 2:3:N+1;c1(end)=N-1;
        a2 = 0:3:N-4;a2(1)=2;     b2    = 1:3:N-3;       c2   = 2:3:N-2;
        d  = N-n+2:1:N;           e     = n+1:1:N-n+1;
        end1 = 2:3:N-2;           end2  = 1:3:N;         end3 = 3:3:N-1;
        
        X(:,1:3:N,:)    = data(:,1:1:n,:);
        X(:,2:3:N-2,:)  = u{7}(1,1)*data(:,d,:)   + u{7}(1,2)*data(:,e,:);
        X(:,3:3:N-1,:)  = u{7}(2,1)*data(:,d,:)   + u{7}(2,2)*data(:,e,:);        
        Xtemp(:,end1,:) = u{1}(1,1)*X(:,a0,:)     + u{1}(1,2)*X(:,b0,:)     + u{1}(1,3)*X(:,c0,:);
        Xtemp(:,end2,:) = u{1}(2,1)*X(:,a1,:)     + u{1}(2,2)*X(:,b1,:)     + u{1}(2,3)*X(:,c1,:);
        Xtemp(:,end3,:) = u{1}(3,1)*X(:,a2,:)     + u{1}(3,2)*X(:,b2,:)     + u{1}(3,3)*X(:,c2,:);        
        X(:,end1,:)     = u{2}(1,1)*Xtemp(:,a0,:) + u{2}(1,2)*Xtemp(:,b0,:) + u{2}(1,3)*Xtemp(:,c0,:);
        X(:,end2,:)     = u{2}(2,1)*Xtemp(:,a1,:) + u{2}(2,2)*Xtemp(:,b1,:) + u{2}(2,3)*Xtemp(:,c1,:);
        X(:,end3,:)     = u{2}(3,1)*Xtemp(:,a2,:) + u{2}(3,2)*Xtemp(:,b2,:) + u{2}(3,3)*Xtemp(:,c2,:);        
        Xtemp(:,end1,:) = u{3}(1,1)*X(:,a0,:)     + u{3}(1,2)*X(:,b0,:)     + u{3}(1,3)*X(:,c0,:);
        Xtemp(:,end2,:) = u{3}(2,1)*X(:,a1,:)     + u{3}(2,2)*X(:,b1,:)     + u{3}(2,3)*X(:,c1,:);
        Xtemp(:,end3,:) = u{3}(3,1)*X(:,a2,:)     + u{3}(3,2)*X(:,b2,:)     + u{3}(3,3)*X(:,c2,:);        
        X(:,end1,:)     = u{4}(1,1)*Xtemp(:,a0,:) + u{4}(1,2)*Xtemp(:,b0,:) + u{4}(1,3)*Xtemp(:,c0,:);
        X(:,end2,:)     = u{4}(2,1)*Xtemp(:,a1,:) + u{4}(2,2)*Xtemp(:,b1,:) + u{4}(2,3)*Xtemp(:,c1,:);
        X(:,end3,:)     = u{4}(3,1)*Xtemp(:,a2,:) + u{4}(3,2)*Xtemp(:,b2,:) + u{4}(3,3)*Xtemp(:,c2,:);        
        Xtemp(:,end1,:) = u{5}(1,1)*X(:,a0,:)     + u{5}(1,2)*X(:,b0,:)     + u{5}(1,3)*X(:,c0,:);
        Xtemp(:,end2,:) = u{5}(2,1)*X(:,a1,:)     + u{5}(2,2)*X(:,b1,:)     + u{5}(2,3)*X(:,c1,:);
        Xtemp(:,end3,:) = u{5}(3,1)*X(:,a2,:)     + u{5}(3,2)*X(:,b2,:)     + u{5}(3,3)*X(:,c2,:);        
        X(:,3:3:N-1,:)  = u{6}(1,1)*Xtemp(:,a0,:) + u{6}(1,2)*Xtemp(:,b0,:) + u{6}(1,3)*Xtemp(:,c0,:);
        X(:,1:3:N,:)    = u{6}(2,1)*Xtemp(:,a1,:) + u{6}(2,2)*Xtemp(:,b1,:) + u{6}(2,3)*Xtemp(:,c1,:);
        X(:,2:3:N-2,:)  = u{6}(3,1)*Xtemp(:,a2,:) + u{6}(3,2)*Xtemp(:,b2,:) + u{6}(3,3)*Xtemp(:,c2,:);
        
    elseif boundType == 2 % finish
        
        n    = (N+1)/3;
        X  = zeros(size(data));   Xtemp = X;
        a0   = 3:3:N-2;           b0    = 4:3:N-1;       c0   = 5:3:N;
        a    = 0:3:N-2;a(1)=2;    b     = 1:3:N-1;       c    = 2:3:N;
        d    = 2*n:1:N-1;         e     = n+1:1:2*n-1;
        end1 = 2:3:N-3;           end2  = 1:3:N-1;       end3 = 3:3:N+1;end3(end)=N;
        
        X(:,1:3:N-1,:)  = data(:,1:1:n,:);
        X(:,2:3:N-3,:)  = u{7}(1,1)*data(:,d,:)   + u{7}(1,2)*data(:,e,:); 
        X(:,3:3:N-2,:)  = u{7}(2,1)*data(:,d,:)   + u{7}(2,2)*data(:,e,:); 
        X(:,N,:)        = u{7}(2,2)*data(:,N,:);         
        Xtemp(:,end1,:) = u{1}(1,1)*X(:,a0,:)     + u{1}(1,2)*X(:,b0,:)     + u{1}(1,3)*X(:,c0,:);
        Xtemp(:,end2,:) = u{1}(2,1)*X(:,a,:)      + u{1}(2,2)*X(:,b,:)      + u{1}(2,3)*X(:,c,:);
        Xtemp(:,end3,:) = u{1}(3,1)*X(:,a,:)      + u{1}(3,2)*X(:,b,:)      + u{1}(3,3)*X(:,c,:);        
        X(:,end1,:)     = u{2}(1,1)*Xtemp(:,a0,:) + u{2}(1,2)*Xtemp(:,b0,:) + u{2}(1,3)*Xtemp(:,c0,:);
        X(:,end2,:)     = u{2}(2,1)*Xtemp(:,a,:)  + u{2}(2,2)*Xtemp(:,b,:)  + u{2}(2,3)*Xtemp(:,c,:);
        X(:,end3,:)     = u{2}(3,1)*Xtemp(:,a,:)  + u{2}(3,2)*Xtemp(:,b,:)  + u{2}(3,3)*Xtemp(:,c,:);        
        Xtemp(:,end1,:) = u{3}(1,1)*X(:,a0,:)     + u{3}(1,2)*X(:,b0,:)     + u{3}(1,3)*X(:,c0,:);
        Xtemp(:,end2,:) = u{3}(2,1)*X(:,a,:)      + u{3}(2,2)*X(:,b,:)      + u{3}(2,3)*X(:,c,:);
        Xtemp(:,end3,:) = u{3}(3,1)*X(:,a,:)      + u{3}(3,2)*X(:,b,:)      + u{3}(3,3)*X(:,c,:);        
        X(:,end1,:)     = u{4}(1,1)*Xtemp(:,a0,:) + u{4}(1,2)*Xtemp(:,b0,:) + u{4}(1,3)*Xtemp(:,c0,:);
        X(:,end2,:)     = u{4}(2,1)*Xtemp(:,a,:)  + u{4}(2,2)*Xtemp(:,b,:)  + u{4}(2,3)*Xtemp(:,c,:);
        X(:,end3,:)     = u{4}(3,1)*Xtemp(:,a,:)  + u{4}(3,2)*Xtemp(:,b,:)  + u{4}(3,3)*Xtemp(:,c,:);        
        Xtemp(:,end1,:) = u{5}(1,1)*X(:,a0,:)     + u{5}(1,2)*X(:,b0,:)     + u{5}(1,3)*X(:,c0,:);
        Xtemp(:,end2,:) = u{5}(2,1)*X(:,a,:)      + u{5}(2,2)*X(:,b,:)      + u{5}(2,3)*X(:,c,:);
        Xtemp(:,end3,:) = u{5}(3,1)*X(:,a,:)      + u{5}(3,2)*X(:,b,:)      + u{5}(3,3)*X(:,c,:);        
        X(:,3:3:N-2,:)  = u{6}(1,1)*Xtemp(:,a0,:) + u{6}(1,2)*Xtemp(:,b0,:) + u{6}(1,3)*Xtemp(:,c0,:);
        X(:,1:3:N-1,:)  = u{6}(2,1)*Xtemp(:,a,:)  + u{6}(2,2)*Xtemp(:,b,:)  + u{6}(2,3)*Xtemp(:,c,:);
        X(:,2:3:N,:)    = u{6}(3,1)*Xtemp(:,a,:)  + u{6}(3,2)*Xtemp(:,b,:)  + u{6}(3,3)*Xtemp(:,c,:);
        
    end
    
end

%---------------------------------------------